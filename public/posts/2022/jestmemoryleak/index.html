<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jest Memory Leaks - Some Lessons Learnt - Lukas Spiss</title>
  <link rel="stylesheet" href="https:&#x2F;&#x2F;www.spiss.dev/screen.css" type="text/css" charset="utf-8" />
  <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;www.spiss.dev/rss.xml" title="Lukas Spiss" />
</head>
<body class="">
  
<h1 class="logo"><a href="https:&#x2F;&#x2F;www.spiss.dev/" class="no-border hover-underline">üë®üèª‚Äçüíª Lukas Spiss</a></h1>

<nav>
  
    
    
      <a href="https:&#x2F;&#x2F;www.spiss.dev&#x2F;" class="no-border hover-underline">Home</a>
    
  
    
    
      <span class="breadcrumb-sep">/</span>
      <a href="https:&#x2F;&#x2F;www.spiss.dev/&#x2F;posts&#x2F;" class="no-border hover-underline">Posts</a>
    
  
    
    
      <span class="breadcrumb-sep">/</span>
      <a href="https:&#x2F;&#x2F;www.spiss.dev/&#x2F;posts&#x2F;2022&#x2F;" class="no-border hover-underline">2022</a>
    
  
</nav>

<article id="jestmemoryleak">
  <h2>
    <a href="https:&#x2F;&#x2F;www.spiss.dev&#x2F;posts&#x2F;2022&#x2F;jestmemoryleak&#x2F;">Jest Memory Leaks - Some Lessons Learnt</a>
  </h2>
  
  <div class="post-metadata">
    <div class="date-published">
      <svg class="date-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" version="1.1" x="0px" y="0px"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M38.6172116,78.6191533 L47.8030928,78.6191533 L47.8030928,69.4332721 L38.6172116,69.4332721 L38.6172116,78.6191533 Z M24.8586734,78.6191533 L34.0445546,78.6191533 L34.0445546,69.4332721 L24.8586734,69.4332721 L24.8586734,78.6191533 Z M66.1332478,64.2656288 L75.319129,64.2656288 L75.319129,55.0797476 L66.1332478,55.0797476 L66.1332478,64.2656288 Z M52.3757498,64.2656288 L61.561631,64.2656288 L61.561631,55.0797476 L52.3757498,55.0797476 L52.3757498,64.2656288 Z M38.6172116,64.2656288 L47.8030928,64.2656288 L47.8030928,55.0797476 L38.6172116,55.0797476 L38.6172116,64.2656288 Z M24.8586734,64.2656288 L34.0445546,64.2656288 L34.0445546,55.0797476 L24.8586734,55.0797476 L24.8586734,64.2656288 Z M66.1332478,49.9110641 L75.319129,49.9110641 L75.319129,40.7251829 L66.1332478,40.7251829 L66.1332478,49.9110641 Z M52.3757498,49.9110641 L61.561631,49.9110641 L61.561631,40.7251829 L52.3757498,40.7251829 L52.3757498,49.9110641 Z M38.6172116,49.9110641 L47.8030928,49.9110641 L47.8030928,40.7251829 L38.6172116,40.7251829 L38.6172116,49.9110641 Z M24.8586734,49.9110641 L34.0445546,49.9110641 L34.0445546,40.7251829 L24.8586734,40.7251829 L24.8586734,49.9110641 Z M13.1607434,90.8382164 L87.7337471,90.8382164 L87.7337471,30.2016227 L13.1607434,30.2016227 L13.1607434,90.8382164 Z M13.1617836,26.0408793 L87.7347873,26.0408793 L87.7347873,16.2662529 L13.1617836,16.2662529 L13.1617836,26.0408793 Z M73.5237682,12.1055095 L73.5237682,5 L69.3630249,5 L69.3630249,12.1055095 L31.5314656,12.1055095 L31.5314656,5 L27.3707222,5 L27.3707222,12.1055095 L9,12.1055095 L9,95 L91.8955307,95 L91.8955307,12.1055095 L73.5237682,12.1055095 Z" fill="currentColor"/></g></svg>
      <time datetime="2022-05-03">03 May 2022</time>
    </div>
  </div>
  

  <div class="post-body">
    <p>Recently I was facing some memory leaks in the test suits of one of my projects. As I spent a couple of days analyzing the issue and finally fixing it, I wanted to summarize the lessons learnt.</p>
<span id="continue-reading"></span><h3 id="project-infos">Project Infos</h3>
<ul>
<li>Nest.JS v8</li>
<li>Node.JS v14</li>
<li>~800 unit tests using Jest</li>
</ul>
<h3 id="the-build-up">The Build Up</h3>
<p>Every once in a while, the Github Actions pipeline would run out of memory during a test run. This is what it looked like:</p>
<pre><code>&lt;--- JS stacktrace ---&gt;

FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory
</code></pre>
<p>While it didn't happen consistently, it was still becoming annoying enough. To make matters worse, a Node.JS update to v16 seemed to make the problem unbearable. Time to investigate üïµüèΩ‚Äç‚ôÇÔ∏è.</p>
<h3 id="node-v16">Node v16</h3>
<p>There seems to be a <a href="https://github.com/facebook/jest/issues/11956">bug</a>, introduced with Node v16.11, causing memory leaks with Jest. While this bug is certainly putting my Node 16 update to a halt until it's resolved, the mentioned Github issue also gives quite some insight on how to debug these kinds of issues. Back to Node 14 üîô.</p>
<h3 id="early-suspicions">Early Suspicions</h3>
<p>Some early ideas what could be causing the issues were:</p>
<ul>
<li>A bad jest/ts-jest/... package update</li>
<li><a href="https://www.npmjs.com/package/jest-ts-auto-mock">Jest-ts-auto-mock</a> as this is messing with the transformer</li>
<li>The <code>setupFilesBeforeEnv</code> which I had added recently</li>
</ul>
<p>In order to verify any assumptions and changes made, the following command was used to see if any memory was leaking:</p>
<p><code>node --expose-gc ./node_modules/.bin/jest --runInBand --logHeapUsage</code></p>
<h3 id="going-back-in-time">Going Back in Time</h3>
<p>In order to see if the problem has been happening for a while, just at a smaller scale, I went back to a commit some months ago and ran the above command. Turns out, back then everything was looking fine!</p>
<p>With that knowledge, I proceded to test whether package updates are responsible for what's happening, but no luck there.</p>
<p>I figured I should try and pin-point to the exact commit where the problem started, but with the normal memory fluctuation it was impossible to spot. To make matters even worse, there seems to be yet a different <a href="https://github.com/facebook/jest/issues/12142">memory issue</a> when using the <code>--runInBand</code> flag.</p>
<h3 id="detectleaks-flag-to-the-rescue">detectLeaks Flag to the Rescue</h3>
<p>Thankfully there is yet another flag called <code>--detectLeaks</code> which will force the garbage collection and fail the test suite if it detects any memory leak.</p>
<p>The updated command: <code>node --expose-gc ./node_modules/.bin/jest --detectLeaks</code></p>
<p>Going back to the same &quot;suspected-memory-leak-free-commit&quot;, this command proved exactly that. Jumping around commits &quot;bisection&quot; style, while running the leak detection every time, very quickly gave me the exact commit which turned every test suite red.</p>
<h3 id="setupfilesafterenv-nock">setupFilesAfterEnv + nock</h3>
<p>Turns out, the issue was the following jest setup file which I introduced to globally disable any external http requests in tests:</p>
<pre data-lang="typescript" class="language-typescript "><code class="language-typescript" data-lang="typescript">&#x2F;&#x2F; jest.setup.ts
import * as nock from &#x27;nock&#x27;;

nock.disableNetConnect();
nock.enableNetConnect(&#x27;127.0.0.1&#x27;)
</code></pre>
<p>There is a section in the <a href="https://github.com/nock/nock#memory-issues-with-jest">nock README</a> which actually describes that exact issue. There is also some more context linked there.</p>
<h3 id="key-lessons-learnt">Key lessons learnt</h3>
<ul>
<li>RTFM</li>
<li>Run tests with <code>--detectLeaks</code> flag, perhaps even in the CI to detect issues right away, instead of facing 5 different issues at the same time once it all bubbles up.</li>
<li>Try out newer transformers such as swc/jest or esbuild/jest for new projects.</li>
</ul>

  </div>
</article>

  <footer class="text-center">
    <div class="socials">
      <a href="https:&#x2F;&#x2F;www.spiss.dev/about/">About</a>
      &bullet;
      <a href="https:&#x2F;&#x2F;www.spiss.dev/rss.xml">RSS</a>
      <a href="mailto:lukas@spiss.dev">Email</a>
      <a href="https://twitter.com/spissable">Twitter</a>
      <a href="https://github.com/spissable">GitHub</a>
    </div>
    <div class="copyright">
      Copyright ¬© 2023 Lukas Spiss &mdash;
      <a href="https://github.com/spissable/spiss.dev">Source on GitHub</a>
    </div>
  </footer>
  <script data-goatcounter="https://spiss.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>

